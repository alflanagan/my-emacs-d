* early-init.org: Emacs early configuration
:PROPERTIES:
:header-args: :tangle early-init.el
:END:

** Enable Lexical Binding
In order to enable lexical binding in the config, this must be the
first line of Emacs Lisp:

#+begin_src emacs-lisp
;; -*- lexical-binding: t -*-
#+end_src

** Note

For the ~init.el~ file, we'll load the org mode and then dynamically
tangle the org file. We can't do that here because we can't yet load
(a customized version of) org. So, we'll use ~org-babel-tangle~ to
manually generate the ~early-init.el~ file.

#+begin_src emacs-lisp
  ;;
  ;; DO NOT EDIT THIS FILE
  ;; It is produced by tangling the file early-config.org, and may be
  ;; overwritten. Edit that file, then execute the `org-babel-tangle'
  ;; command.
#+end_src

** Tweaks of Garbage Collection

We increase the GC threshold during startup, which reduces startup time by
not performing unnecessary collections.

See
https://emacsredux.com/blog/2025/03/28/speed-up-emacs-startup-by-tweaking-the-gc-settings/
for a good discussion

Temporarily increase GC threshold during startup. This saves about 1.8
seconds on startup time in early testing. Your milage may vary.

#+begin_src emacs-lisp
(setopt gc-cons-threshold most-positive-fixnum)
#+end_src

Restore to a more normal value after startup. However, 800K is emacs'
startup default, which is probably much too low on modern machines. We
need to try higher settings to see if they impove performance.

#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook
    (lambda () (setopt gc-cons-threshold (* 5 1024 1024))))

(setopt garbage-collection-messages t) ;; show GC messages for debugging
#+end_src

** Mac-Specific Setups

First we need to fix the library path for gcc compilation. *This is
almost certainly wrong* for your machine. Customize, or try commenting
out and seeing if it just works as-is.

#+begin_src emacs-lisp
  (if (equal system-type 'darwin)
         (setenv
          "LIBRARY_PATH"
          (string-join
           '("/opt/homebrew/opt/gcc/lib/gcc/13"
             "/opt/homebrew/opt/libgccjit/lib/gcc/13"
             "/opt/homebrew/Cellar/gcc/13.2.0/lib/gcc/current/gcc/aarch64-apple-darwin23/13")
           ":")))
#+end_src

** Initial Frame Size

We need to set this in early-init to set for intitial frame.

**** TODO determine initial values from screen size.

#+begin_src emacs-lisp
(setopt initial-frame-alist
      '((horizontal-scroll-bars)
        (vertical-scroll-bars)
        (width . 150)
        (height . 40)))
#+end_src

** Always Use .el File When Newer

We set this here so it gets applied to load of init.el (we hope). IMHO
the default value of this being ~nil~ is nuts.

#+begin_src emacs-lisp
(setopt load-prefer-newer t)
#+end_src

** End

Finally add a comment so we know the whole file is present.

#+begin_src emacs-lisp
;;; early-init.el ends here
#+end_src
